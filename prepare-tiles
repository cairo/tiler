#!/bin/sh

set -x

download_tiles() {
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/a1.jpg a1.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/a2.jpg a2.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/b1.jpg b1.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/b2.jpg b2.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/c1.jpg c1.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/c2.jpg c2.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/d1.jpg d1.jpg
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp s3://$OUTPUT_BUCKET_NAME/$1/d2.jpg d2.jpg
}

translate_tiles() {
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr -180 90 -90 0 a1.jpg a1.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr -180 0 -90 -90 a2.jpg a2.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr -90 90 0 0 b1.jpg b1.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr -90 0 0 -90 b2.jpg b2.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr 0 90 90 0 c1.jpg c1.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr 0 0 90 -90 c2.jpg c2.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr 90 90 180 0 d1.jpg d1.tif
    gdal_translate -of GTiff -a_srs EPSG:4326 -a_ullr 90 0 180 -90 d2.jpg d2.tif
}

build_xyz_tiles() {
    gdalbuildvrt mosaic.vrt *.tif
    gdal2tiles.py -v --zoom 0-8 mosaic.vrt tiles
}

upload_xyz_tiles() {
    aws --endpoint-url $AWS_ENDPOINT_URL s3 cp tiles s3://$OUTPUT_BUCKET_NAME/$OUTPUT_DIR/$1
}

download_tiles "raw/winter"
translate_tiles
build_xyz_tiles
upload_xyz_tiles "imagery/winter"
